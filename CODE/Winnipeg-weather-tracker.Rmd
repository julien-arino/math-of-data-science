---
title: "Winnipeg Daily Weather Tracker"
author: "Automated Weather Collection"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)

# Load required libraries
library(httr)
library(jsonlite)
library(dplyr)
library(ggplot2)
library(lubridate)
library(readr)
library(circular)
```

## Weather Data Collection for Winnipeg

This script automatically collects weather data for Winnipeg and maintains a historical record.

```{r weather-functions}
# Function to get weather data from OpenWeatherMap API
# You'll need to get a free API key from https://openweathermap.org/api
get_weather_data <- function(api_key = NULL) {
  
  # If no API key provided, try to use a demo approach with a weather service
  # For production, you should get an API key from OpenWeatherMap
  
  if (is.null(api_key)) {
    # Using Environment and Climate Change Canada data as fallback
    # This is a simplified approach - in practice you might want to use wttr.in or another service
    
    # Get current weather data for Winnipeg
    tryCatch({
      # Using wttr.in service which doesn't require API key
      response <- GET("http://wttr.in/Winnipeg?format=j1")
      
      if (status_code(response) == 200) {
        weather_data <- fromJSON(content(response, "text"))
        
        # Extract relevant information
        current <- weather_data$current_condition[[1]]
        
        # Get yesterday's date
        yesterday <- Sys.Date() - 1
        
        # For this demo, we'll use current temperature as proxy for yesterday
        # In a real implementation, you'd use historical weather API
        temp_data <- data.frame(
          date = yesterday,
          mean_temp_c = as.numeric(current$temp_C),
          max_temp_c = as.numeric(current$temp_C) + runif(1, 0, 5),  # Simulated
          min_temp_c = as.numeric(current$temp_C) - runif(1, 0, 5),  # Simulated
          humidity = as.numeric(current$humidity),
          wind_speed_kmh = as.numeric(current$windspeedKmph),
          wind_dir_deg = as.numeric(current$winddirDegree),
          collected_at = Sys.time()
        )
        
        return(temp_data)
      }
    }, error = function(e) {
      cat("Error fetching weather data:", e$message, "\n")
      return(NULL)
    })
  } else {
    # Use OpenWeatherMap API if key is provided
    tryCatch({
      # Winnipeg coordinates
      lat <- 49.8951
      lon <- -97.1384
      
      url <- paste0("https://api.openweathermap.org/data/2.5/weather?lat=", 
                    lat, "&lon=", lon, "&appid=", api_key, "&units=metric")
      
      response <- GET(url)
      
      if (status_code(response) == 200) {
        data <- fromJSON(content(response, "text"))
        
        temp_data <- data.frame(
          date = Sys.Date() - 1,  # Previous day
          mean_temp_c = data$main$temp,
          max_temp_c = data$main$temp_max,
          min_temp_c = data$main$temp_min,
          humidity = data$main$humidity,
          wind_speed_kmh = data$wind$speed * 3.6,  # Convert m/s to km/h
          wind_dir_deg = ifelse(is.null(data$wind$deg), NA, data$wind$deg),
          collected_at = Sys.time()
        )
        
        return(temp_data)
      }
    }, error = function(e) {
      cat("Error fetching weather data:", e$message, "\n")
      return(NULL)
    })
  }
  
  return(NULL)
}

# Function to append data to CSV file
append_to_csv <- function(new_data, filename = "winnipeg_weather_data.csv") {
  
  if (is.null(new_data)) {
    cat("No data to append.\n")
    return(FALSE)
  }
  
  # Check if file exists
  if (file.exists(filename)) {
    # Read existing data
    existing_data <- read_csv(filename, show_col_types = FALSE)
    
    # Check if we already have data for this date
    if (new_data$date %in% existing_data$date) {
      cat("Data for", as.character(new_data$date), "already exists. Skipping.\n")
      return(FALSE)
    }
    
    # Combine data
    combined_data <- bind_rows(existing_data, new_data)
  } else {
    # Create new file
    combined_data <- new_data
    cat("Creating new weather data file:", filename, "\n")
  }
  
  # Write to CSV
  write_csv(combined_data, filename)
  cat("Weather data appended successfully for", as.character(new_data$date), "\n")
  return(TRUE)
}
```

```{r collect-data}
# Collect weather data
cat("Collecting weather data for Winnipeg...\n")

# You can set your OpenWeatherMap API key here
# api_key <- "your_api_key_here"  # Uncomment and add your API key
api_key <- NULL  # Using free service for demo

new_weather_data <- get_weather_data(api_key)

if (!is.null(new_weather_data)) {
  print(new_weather_data)
  
  # Append to CSV file
  append_to_csv(new_weather_data)
} else {
  cat("Failed to collect weather data.\n")
}
```

```{r load-and-plot-temperature}
# Load historical data and create temperature plot
csv_file <- "winnipeg_weather_data.csv"

if (file.exists(csv_file)) {
  weather_history <- read_csv(csv_file, show_col_types = FALSE)
  
  cat("Loaded", nrow(weather_history), "weather records.\n")
  
  # Create temperature plot
  temp_plot <- ggplot(weather_history, aes(x = as.Date(date))) +
    geom_line(aes(y = mean_temp_c), color = "blue", size = 1, alpha = 0.8) +
    geom_point(aes(y = mean_temp_c), color = "blue", size = 2) +
    geom_ribbon(aes(ymin = min_temp_c, ymax = max_temp_c), alpha = 0.3, fill = "lightblue") +
    labs(
      title = "Winnipeg Daily Temperature History",
      subtitle = paste("Data from", min(weather_history$date), "to", max(weather_history$date)),
      x = "Date",
      y = "Temperature (째C)"
    ) +
    theme_minimal() +
    theme(
      plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
      plot.subtitle = element_text(hjust = 0.5, size = 12),
      axis.text.x = element_text(angle = 45, hjust = 1)
    ) +
    scale_x_date(date_breaks = "1 week", date_labels = "%b %d")
  
  print(temp_plot)
  
  # Save the plot
  ggsave("winnipeg_temperature_history.png", temp_plot, width = 10, height = 6, dpi = 300)
  
} else {
  cat("No historical weather data file found.\n")
}
```

```{r wind-data-and-plot}
# Generate wind direction plot
if (file.exists(csv_file)) {
  
  # Filter out NA wind directions and recent data (last 24 hours worth of records)
  wind_data <- weather_history %>%
    filter(!is.na(wind_dir_deg)) %>%
    tail(24)  # Get last 24 records as proxy for 24 hours
  
  if (nrow(wind_data) > 0) {
    
    # Create wind rose plot
    wind_plot <- ggplot(wind_data, aes(x = wind_dir_deg, y = wind_speed_kmh)) +
      geom_point(aes(color = wind_speed_kmh), size = 3, alpha = 0.7) +
      coord_polar(start = 0) +
      scale_x_continuous(
        limits = c(0, 360),
        breaks = seq(0, 315, 45),
        labels = c("N", "NE", "E", "SE", "S", "SW", "W", "NW")
      ) +
      scale_color_gradient(
        low = "lightblue", 
        high = "darkblue",
        name = "Wind Speed\n(km/h)"
      ) +
      labs(
        title = "Wind Direction and Speed - Last 24 Records",
        subtitle = "Winnipeg Wind Patterns",
        x = "Wind Direction",
        y = "Wind Speed (km/h)"
      ) +
      theme_minimal() +
      theme(
        plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
        plot.subtitle = element_text(hjust = 0.5, size = 12),
        axis.text.x = element_text(size = 10),
        legend.position = "right"
      )
    
    print(wind_plot)
    
    # Save the wind plot
    ggsave("winnipeg_wind_pattern.png", wind_plot, width = 10, height = 8, dpi = 300)
    
    # Create a simple wind direction histogram
    wind_hist <- ggplot(wind_data, aes(x = wind_dir_deg)) +
      geom_histogram(bins = 16, fill = "steelblue", alpha = 0.7, color = "white") +
      coord_polar(start = 0) +
      scale_x_continuous(
        limits = c(0, 360),
        breaks = seq(0, 315, 45),
        labels = c("N", "NE", "E", "SE", "S", "SW", "W", "NW")
      ) +
      labs(
        title = "Wind Direction Frequency - Last 24 Records",
        subtitle = "Winnipeg Wind Direction Distribution",
        x = "Wind Direction",
        y = "Frequency"
      ) +
      theme_minimal() +
      theme(
        plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
        plot.subtitle = element_text(hjust = 0.5, size = 12)
      )
    
    print(wind_hist)
    ggsave("winnipeg_wind_direction_histogram.png", wind_hist, width = 10, height = 8, dpi = 300)
    
  } else {
    cat("No wind data available for plotting.\n")
  }
  
} else {
  cat("No weather data available for wind analysis.\n")
}
```

```{r summary}
# Print summary of current data
if (exists("weather_history")) {
  cat("\n=== WEATHER DATA SUMMARY ===\n")
  cat("Total records:", nrow(weather_history), "\n")
  cat("Date range:", as.character(min(weather_history$date)), "to", as.character(max(weather_history$date)), "\n")
  cat("Temperature range:", round(min(weather_history$min_temp_c, na.rm = TRUE), 1), "째C to", round(max(weather_history$max_temp_c, na.rm = TRUE), 1), "째C\n")
  cat("Average temperature:", round(mean(weather_history$mean_temp_c, na.rm = TRUE), 1), "째C\n")
  
  if (any(!is.na(weather_history$wind_speed_kmh))) {
    cat("Average wind speed:", round(mean(weather_history$wind_speed_kmh, na.rm = TRUE), 1), "km/h\n")
  }
  
  cat("Last data collection:", as.character(max(weather_history$collected_at)), "\n")
}
```

## Notes for Cron Setup

When you're ready to set this up with crontab, you'll want to:

1. **Get an API key** from [OpenWeatherMap](https://openweathermap.org/api) (free tier allows 1000 calls/day)
2. **Update the API key** in the `api_key` variable
3. **Set up the cron job** to run this script daily, for example:
   ```bash
   # Run every day at 6 AM
   0 6 * * * Rscript -e "rmarkdown::render('/path/to/winnipeg_weather_tracker.Rmd')"
   ```
4. **Ensure the working directory** is set correctly so the CSV file is created in the right location
5. **Consider logging** by redirecting output: `>> /path/to/weather_log.txt 2>&1`

The script will automatically:
- Skip duplicate dates
- Maintain a growing CSV file
- Generate updated plots each time it runs
- Handle errors gracefully
